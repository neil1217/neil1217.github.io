<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改檔用V2.0</title>
    <style>
        body {
            background-color: #333;
            margin: 0px;
        }

        div.btn {
            height: 50px;
            width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
        }

        div.edit {
            width: 900px;
            margin: 0 auto;
        }

        button {
            height: 25px;
            margin-right: 10px;

        }

        button.copy {
            display: none;
        }

        button.copy.on {
            display: block;
        }

        #editableArea {
            border: 1px solid #374366;
            height: 509px;
            width: 100%;
            background-color: #f9f9f9;
            overflow-x: auto;
            margin: 0 auto;
        }

        #htmlOutput {
            border: 1px solid #1e2d55;
            padding: 10px;
            white-space: pre-wrap;
            background-color: #222;
            max-height: 300px;
            overflow-y: auto;
            color: #fff;
            font-family: monospace;
            /* 让文本显示为等宽字体，方便查看原始代码 */
            white-space: pre-wrap;
            /* 保留空格和换行 */
            word-wrap: break-word;
            /* 防止长文本溢出 */
        }
    </style>
</head>

<body>


    <!-- 用户可以粘贴格式化文本的区域 -->
    <div class="good">
        <div class="btn">
            <select class="webselector">
                <option value="web0">web</option>
                <option value="blm">blm</option>
                <option value="bwin">bwin</option>
            </select>
            <button onclick="convertToHtml()">轉換</button>
            <button onclick="convertToHtml()" class="copy">複製</button>
        </div>
        <div class="edit">
            <div id="editableArea" contenteditable="true" placeholder="貼上WORD"></div>
        </div>
    </div>





    <div id="htmlOutput"></div>
    <script src="xi.js"></script>
    <script>



        let webselector = document.querySelector('.webselector')
        webselector.addEventListener('change', (e) => {
            localStorage.setItem('web', e.target.value)
        })




        function convertToHtml() {

            localStorage.setItem('web', 'web0')
            let web = localStorage.getItem('web')
            if (web === 'web0') {
                web = {
                    trcolor: 'red',
                    strong: '',
                    spancolor: 'red',
                    emcolor: 'red',
                    strongOrange2: false
                }
            } else if (web === 'bwin') {
                web = {
                    trcolor: 'red',
                    strong: 'orange2',
                    spancolor: 'red',
                    emcolor: 'orange2',
                    strongOrange2: true
                }
            }





            // 获取用户粘贴的内容
            let content = document.getElementById("editableArea").innerHTML;


            // 移除不必要的标签
            content = content.replace(/<o:p><\/o:p>/g, '');
            content = content.replace(/&nbsp;/g, '')
            content = content.replace(/\<!--[\s\S]*?--\>/g, '');

            console.log(content);


            let tempDiv = document.createElement('div');
            tempDiv.classList.add('outout')
            tempDiv.innerHTML = content;
            let vAll1 = tempDiv.innerText
            let elements = tempDiv.querySelectorAll('*');
            elements.forEach(element => {
                if (!element.innerText &&
                    element.tagName.toLowerCase() !== 'img' &&
                    !element.querySelector('a') &&
                    !element.querySelector('img')) {
                    element.tagName.toLowerCase() !== 'a' ? element.remove() : element标签
                }
                // // 删除除 style 属性以外的所有属性
                const attributes = element.attributes;
                for (let i = attributes.length - 1; i >= 0; i--) {
                    const attribute = attributes[i];
                    if (attribute.name !== 'style' && attribute.name !== 'src' && attribute.name !== 'border-collapse' && attribute.name !== 'colspan' && attribute.name !== 'rowspan' && attribute.name !== 'href' && attribute.name !== 'target') {
                        element.removeAttribute(attribute.name);
                    }
                }
                if (element.hasAttribute('style')) {
                    let style = element.getAttribute('style');
                    // 移除多余的换行符和空格
                    style = style.replace(/\s+/g, '').trim().toLowerCase();

                    let cleanedStyle = style.split(';')
                    let cleanedStyleAll = cleanedStyle.filter((styleItem) => {
                        if (styleItem.startsWith('color:#e03e2d') || styleItem.startsWith('color:#ed7d31') || styleItem.startsWith('color:rgb\(224 62 45\)') || styleItem.startsWith('color:red')) {
                            element.classList.add(`${web.spancolor}`)
                            return false
                        } else if (styleItem.startsWith('color:rgb\(237,125,49\)') || styleItem.startsWith('color:rgb\(254,152,42\)') || styleItem.startsWith('color:#c45911')) {
                            element.classList.add(`${web.emcolor}`)
                            return false
                        } else if (styleItem.startsWith('color:rgb(51,51,51)') || styleItem.startsWith('color:#333333')) {
                            return false
                        } else if (styleItem.startsWith('color:white')) {
                            return false
                        } else if (styleItem.startsWith('color:')) {
                            return true
                        } else if (styleItem.startsWith('font-size:')) {
                            const fontSize = styleItem.match(/font-size:\s*(\d+)/)
                            fontSize[1] > 18 ? element.classList.add('title') : styleItem
                            return false
                        } else if (element.tagName === 'TD') {
                            if (styleItem.startsWith('background:#920000') || styleItem.startsWith('background:#930211')) {
                                element.parentElement.classList.add(`${web.trcolor}`)
                                return false
                            }
                            return false
                        } else {
                            return false
                        }


                    });
                    let styleList = cleanedStyleAll.join(';').trim()
                    styleList && styleList.length !== 0 ? element.style.cssText = `${styleList}` : element.removeAttribute('style')
                }

                if (element.tagName.toLowerCase() === 'img') {
                    element.src = 'http://file1.sg.local'
                    if (element.parentElement.parentElement && element.parentElement.parentElement.tagName !== 'TD') {
                        if (element.parentElement.tagName !== 'A' && element.parentElement.parentElement.tagName !== 'A') {
                            const img = document.createElement('img')
                            img.src = 'http://file1.sg.local'

                            element.parentElement.parentElement.replaceWith(img);
                        }

                    }
                    if (element.parentElement && element.parentElement.tagName !== 'TD') {
                        if (element.parentElement.tagName !== 'A') {
                            const img = document.createElement('img')
                            img.src = 'http://file1.sg.local'
                            element.parentElement.replaceWith(img);
                        }

                    }
                }
            })


            let vAll2 = tempDiv.innerText
            if (vAll1 === vAll2) {
                console.log('文字相同');

            } else {
                console.log('文字不同');
                console.log(vAll1);
                console.log(vAll2);
            }


            content2 = tempDiv.innerHTML

            contentall = content2.replace(/>\s+</g, '><');
            let flag = true
            let cleanedContent2 = function doSpanWhile() {
                while (flag) {
                    let v1 = contentall
                    contentall = contentall.replace(/<div>/g, '')
                    contentall = contentall.replace(/<\/div>/g, '')
                    contentall = contentall.replace(/<p><\/p>/g, '')
                    contentall = contentall.replace(/<b><\/b>/g, '')
                    contentall = contentall.replace(/<em><\/em>/g, '')
                    contentall = contentall.replace(/<span><\/span>/g, '')
                    contentall = contentall.replace(/<span>([\s\S]*?)<\/span>/g, (match, content1) => {
                        return `${content1}`;
                    })
                    contentall = contentall.replace(/<b>([\s\S]*?)<\/b>/g, (match, content1) => {
                        return `${content1}`;
                    })
                    contentall = contentall.replace(/<em>([\s\S]*?)<\/em>/g, (match, content1) => {
                        return `${content1}`;
                    })
                    let v2 = contentall
                    if (v1 === v2) {
                        return contentall
                        flag = false
                    }
                }
            }

            content2 = cleanedContent2()

            content2 = content2.replace(/\n+/g, '')
            tempDiv.innerHTML = content2;


            console.log(tempDiv);
            const pAll = tempDiv.querySelectorAll('p')
            pAll.forEach(e => {
                if (e.parentElement && e.parentElement.tagName === 'TD' && e.classList.value === '' && e.style.cssText === '') {
                    let pInnertext = e.innerHTML.replace(' ', '')
                    e.parentElement.innerHTML = pInnertext.replace('class', ' class')
                    e.remove()

                } else if (e.innerText.length !== 0 && e.childNodes.length !== 0) {
                    let childTagname = ''
                    let cssstr = ''
                    let classstr = ''
                    let str = ''
                    for (let i = 0; i < e.childNodes.length; i++) {
                        const ec = e.childNodes[i]
                        if (ec.tagName) {
                            childTagname = ec.tagName
                            if (ec.style && ec.style.cssText.length !== 0) {
                                cssstr = ec.style.cssText
                                console.log(cssstr);

                            }
                            if (ec.classList && ec.classList.value.length !== '') {
                                classstr = ec.classList.value
                            }
                            str = ec.innerText
                            if (e.innerText === str) {
                                if (cssstr !== '') {
                                    if (e.style.cssText && e.style.cssText.length === 0) {
                                        e.style.cssText = cssstr
                                    } else {
                                        e.style.cssText += cssstr
                                    }
                                }
                                if (classstr !== '') {
                                    if (e.classList.value.length === 0) {
                                        e.classList.value = classstr
                                    } else {
                                        e.classList.value += classstr
                                    }
                                }
                                e.innerHTML = str
                                ec.remove()
                            } else {
                                if (ec.nextSibling) {
                                    const chi = ec.nextSibling.tagName || 0
                                    if (chi && ec.nextSibling.tagName === childTagname) {
                                        const ecNext = ec.nextSibling
                                        if (ecNext.style.cssText === cssstr && ecNext.classList.value === classstr) {
                                            str += ecNext.innerText
                                            ecNext.innerText = str
                                            ec.remove()
                                            i -= 1


                                        }
                                    }
                                }
                            }
                        }
                    }
                } else if (e.innerText.length !== 0 && e.childNodes.length === 0) {
                    console.log(e.innerText);
                    e.innerText = e.innerText.replace(/' '/g, '')
                    console.log(e.innerText);


                }



            })

            const aAll = tempDiv.querySelectorAll('A')
            aAll.forEach(e => {
                if (e.parentElement && e.parentElement.tagName === 'TD' && e.classList.value === '' && e.style.cssText === '') {
                    e.parentElement.innerHTML = e.innerHTML
                    e.remove()
                } else if (e.innerText !== 0 && e.childNodes.length !== 0) {
                    let childTagname = ''
                    let cssstr = ''
                    let classstr = ''
                    let str = ''
                    for (let i = 0; i < e.childNodes.length; i++) {
                        const ec = e.childNodes[i]
                        if (ec.tagName) {
                            if (ec.tagName !== 'IMG') {
                                childTagname = ec.tagName
                                if (ec.style && ec.style.cssText.length !== 0) {
                                    cssstr = ec.style.cssText
                                }
                                if (ec.classList && ec.classList.value.length !== '') {
                                    classstr = ec.classList.value
                                }
                                str = ec.innerText
                                if (e.innerText === str) {
                                    if (cssstr !== '') {
                                        if (e.style.cssText && e.style.cssText.length === 0) {
                                            e.style.cssText = cssstr
                                        } else {
                                            e.style.cssText += cssstr
                                        }
                                    }
                                    if (classstr !== '') {
                                        if (e.classList.value.length === 0) {
                                            e.classList.value = classstr
                                        } else {
                                            e.classList.value += classstr
                                        }
                                    }
                                    e.innerHTML = str
                                    ec.remove()
                                } else {
                                    if (ec.nextSibling) {
                                        const chi = ec.nextSibling.tagName || 0
                                        if (chi && ec.nextSibling.tagName === childTagname) {
                                            const ecNext = ec.nextSibling
                                            if (ecNext.style.cssText === cssstr && ecNext.classList.value === classstr) {
                                                str += ecNext.innerText
                                                ecNext.innerText = str
                                                ec.remove()
                                                i -= 1


                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (e.parentElement) {
                    const dad = e.parentElement
                    if (dad.tagName === 'SPAN' && dad.innerText === e.innerText) {
                        const newA = document.createElement('a')
                        newA.target = '_blank'
                        newA.innerText = e.innerText
                        if (e.hasAttributes()) {
                            const attributes = e.getAttributeNames();
                            attributes.forEach(attr => {
                                newA.setAttribute(attr, e.getAttribute(attr));
                            });
                        }
                        e.attributes
                        if (dad.styleList) {
                            if (dad.styleList === e.styleList) {
                                newA.styleList.cssText = dad.styleList.value
                            }
                        }
                        if (dad.classList) {
                            if (dad.classList.value === e.classList.value) {
                                newA.classList.value = dad.classList.value
                            }
                        }
                        if (dad.parentElement) {
                            dad.parentElement.insertBefore(newA, dad)
                            dad.remove()
                        }
                    }

                }
            })

            const tdAll = tempDiv.querySelectorAll('td')
            tdAll.forEach(e => {
                if (e.innerText !== 0 && e.childNodes.length !== 0) {
                    let childTagname = ''
                    let cssstr = ''
                    let classstr = ''
                    let str = ''
                    for (let i = 0; i < e.childNodes.length; i++) {
                        const ec = e.childNodes[i]
                        if (ec.tagName) {
                            childTagname = ec.tagName
                            if (ec.style && ec.style.cssText.length !== 0) {
                                cssstr = ec.style.cssText
                            }
                            if (ec.classList && ec.classList.value.length !== '') {
                                classstr = ec.classList.value
                            }
                            str = ec.innerText
                            if (e.innerText === str) {
                                if (cssstr !== '') {
                                    if (e.style.cssText && e.style.cssText.length === 0) {
                                        e.style.cssText = cssstr
                                    } else {
                                        e.style.cssText += cssstr
                                    }
                                }
                                if (classstr !== '') {
                                    if (e.classList.value.length === 0) {
                                        e.classList.value = classstr
                                    } else {
                                        e.classList.value += classstr
                                    }
                                }
                                e.innerHTML = str
                                ec.remove()
                            } else {
                                if (ec.nextSibling) {
                                    const chi = ec.nextSibling.tagName || 0
                                    if (chi && ec.nextSibling.tagName === childTagname) {
                                        const ecNext = ec.nextSibling
                                        if (ecNext.style.cssText === cssstr && ecNext.classList.value === classstr) {
                                            str += ecNext.innerText
                                            ecNext.innerText = str
                                            ec.remove()
                                            i -= 1
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            })

            const spanAll = tempDiv.querySelectorAll('span')
            spanAll.forEach(e => {
                if (e.parentElement && e.parentElement.tagName === 'P') {
                    const newEm = document.createElement('em')
                    if (e.style.cssText !== '') {
                        newEm.style.cssText = e.style.cssText
                    }
                    const str = e.classList.value.trim()
                    if (e.classList.value !== '') {
                        newEm.classList.value = `${str}`
                    }
                    newEm.innerText = e.innerText.replace(/[\s]/g, '')
                    e.parentElement.insertBefore(newEm, e)
                    e.remove()
                }
            })

            const titlestrong = tempDiv.querySelectorAll('.title')
            titlestrong.forEach(e => {
                if (web.strongOrange2) {
                    const newItem = document.createElement('strong')
                    newItem.classList.value = 'orange2'
                    newItem.innerText = e.innerText
                    tempDiv.insertBefore(newItem, e)
                    e.remove()

                } else {
                    const newItem = document.createElement('strong')
                    newItem.classList.remove()
                    newItem.innerText = e.innerText
                    tempDiv.insertBefore(newItem, e)
                    e.remove()
                }
            })

            const tableall = tempDiv.querySelectorAll('table')
            tableall.forEach(e => {
                let count = 0
                let etrindex = ''
                e.querySelectorAll('tr').forEach((etr, index) => {
                    if (etr.childNodes.length > count) {
                        count = etr.childNodes.length
                        etrindex = index
                    }
                })
                e.querySelectorAll(`tr`)[etrindex].childNodes.forEach(etd => {
                    etd.style = `width:${100 / count}%;`
                })
            })

            let cleanedContent = tempDiv.innerHTML.trim();
            cleanedContent = cleanedContent.replace(/<\/p>/g, '</p>\n')
            cleanedContent = cleanedContent.replace(/<\/strong>/g, '</strong>\n')
            cleanedContent = cleanedContent.replace(/<table>/g, '<table>\n')
            cleanedContent = cleanedContent.replace(/<\/table>/g, '</table>\n')
            cleanedContent = cleanedContent.replace(/<tbody>/g, '<tbody>\n')
            cleanedContent = cleanedContent.replace(/<\/tbody>/g, '</tbody>\n')
            cleanedContent = cleanedContent.replace(/<tr>/g, '<tr>\n')
            cleanedContent = cleanedContent.replace(/<tr ([^>]+)>/g, '<tr $1>\n')
            cleanedContent = cleanedContent.replace(/<\/tr>/g, '</tr>\n')
            cleanedContent = cleanedContent.replace(/<td>/g, '<td>\n')
            cleanedContent = cleanedContent.replace(/<td ([^>]+)>/g, '<td $1>\n')
            cleanedContent = cleanedContent.replace(/<\/td>/g, '\n</td>\n')
            // 显示为纯文本形式，不渲染 HTML
            document.getElementById("htmlOutput").textContent = cleanedContent;
            //渲染
            //document.getElementById("htmlOutput").innerHTML = cleanedContent;

            //開啟複製按鈕
            document.querySelector('.copy').classList.add('on')



            document.querySelector('.copy').addEventListener('click', function () {
                navigator.clipboard.writeText(document.getElementById("htmlOutput").textContent)
                alert('代碼已複製！');
            });
        }




    </script>
</body>

</html>
